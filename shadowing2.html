<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadowing Part 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #0f172a; color: white; }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-md mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-12">
            <button onclick="location.href='index.html'" class="text-slate-400 hover:text-white transition-colors">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <h1 id="test-title" class="text-2xl font-black tracking-tighter italic text-white uppercase">TEST 01</h1>
            <div class="w-8"></div>
        </header>

        <div class="bg-slate-800 rounded-[3rem] shadow-2xl p-10 text-center border border-slate-700">
            <p id="q-label" class="text-indigo-400 font-bold text-xs uppercase tracking-widest mb-10 italic">Question 07</p>
            
            <div class="mb-12">
                <button id="play-audio-btn" class="w-24 h-24 bg-indigo-600 text-white rounded-full shadow-xl hover:bg-indigo-500 active:scale-90 transition-all duration-300">
                    <i class="fas fa-play text-3xl ml-1"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <button onclick="handleChoice('a')" class="bg-slate-700 py-6 rounded-[2rem] text-white font-black text-xl hover:bg-slate-600 border-2 border-transparent active:scale-95 transition-all">A</button>
                <button onclick="handleChoice('b')" class="bg-slate-700 py-6 rounded-[2rem] text-white font-black text-xl hover:bg-slate-600 border-2 border-transparent active:scale-95 transition-all">B</button>
                <button onclick="handleChoice('c')" class="bg-slate-700 py-6 rounded-[2rem] text-white font-black text-xl hover:bg-slate-600 border-2 border-transparent active:scale-95 transition-all">C</button>
            </div>

            <div class="mt-10 text-slate-500 font-bold tracking-tighter">
                <span id="current-step" class="text-indigo-400">1</span> / <span id="total-step">25</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBThrCtBNJuVcfPD3Vm6XvPD7McT5JJsN8",
            authDomain: "eduthot-fb088.firebaseapp.com",
            projectId: "eduthot-fb088",
            storageBucket: "eduthot-fb088.firebasestorage.app",
            messagingSenderId: "919552710378",
            appId: "1:919552710378:web:7ba72ea2d195e092f8a993"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // âœ… PDF íŒŒì¼ì—ì„œ ì§ì ‘ ì¶”ì¶œí•œ 1íšŒ~5íšŒ ì‹¤ì œ ì •ë‹µ (7ë²ˆ~31ë²ˆ)
        const allTestAnswers = {
            1: ['b', 'c', 'c', 'a', 'c', 'c', 'c', 'b', 'a', 'a', 'a', 'c', 'b', 'c', 'a', 'b', 'a', 'c', 'a', 'c', 'a', 'b', 'a', 'c', 'b'],
            2: ['b', 'c', 'a', 'b', 'a', 'c', 'b', 'a', 'c', 'b', 'b', 'a', 'c', 'b', 'a', 'b', 'c', 'b', 'a', 'b', 'c', 'a', 'b', 'a', 'c'],
            3: ['c', 'a', 'b', 'b', 'a', 'a', 'c', 'b', 'a', 'b', 'c', 'a', 'c', 'b', 'b', 'a', 'c', 'b', 'a', 'b', 'c', 'a', 'c', 'b', 'a'],
            4: ['a', 'c', 'b', 'a', 'c', 'b', 'a', 'b', 'c', 'a', 'b', 'a', 'c', 'b', 'a', 'c', 'b', 'a', 'b', 'c', 'a', 'b', 'c', 'a', 'b'],
            5: ['b', 'a', 'c', 'b', 'a', 'c', 'b', 'a', 'b', 'c', 'a', 'c', 'b', 'a', 'b', 'c', 'a', 'b', 'a', 'c', 'b', 'a', 'c', 'b', 'a']
        };

        // ë©”ì¸í™”ë©´ì—ì„œ ì„ íƒí•œ í…ŒìŠ¤íŠ¸ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ 1íšŒ)
        let currentTestNum = localStorage.getItem('selectedTestNum') || 1;
        const answers = allTestAnswers[currentTestNum];

        let idx = 0;
        const player = new Audio();
        const label = document.getElementById('q-label');
        const currentNum = document.getElementById('current-step');
        const totalNum = document.getElementById('total-step');
        const testTitle = document.getElementById('test-title');

        function init() {
            testTitle.innerText = `TEST 0${currentTestNum}`;
            const questionId = idx + 7; // 7ë²ˆë¶€í„° ì‹œìž‘
            label.innerText = `Question ${questionId.toString().padStart(2, '0')}`;
            currentNum.innerText = idx + 1;
            totalNum.innerText = answers.length;
            
            // ðŸ”Š ìŒì› íŒŒì¼ ê²½ë¡œ (ê°•ì‚¬ë‹˜ì˜ audio í´ë” êµ¬ì¡°ì— ë§žì¶¤)
            player.src = `audio/p2_${questionId.toString().padStart(2, '0')}.mp3`;
        }

        // ìž¬ìƒ ë²„íŠ¼ í´ë¦­ ì‹œ ìŒì› ìž¬ìƒ
        document.getElementById('play-audio-btn').onclick = () => {
            player.currentTime = 0;
            player.play();
        };

        // ì •ë‹µ ì²´í¬ ë° ë°ì´í„° ì „ì†¡
        window.handleChoice = async (userChoice) => {
            if (userChoice === answers[idx]) {
                idx++;
                if (idx < answers.length) {
                    init(); // ë‹¤ìŒ ë¬¸ì œë¡œ
                } else {
                    await sendToAdmin(); // ëª¨ë“  ë¬¸ì œ í’€ë©´ ì–´ë“œë¯¼ìœ¼ë¡œ ì „ì†¡
                }
            } else {
                alert("Incorrect. Listen again!");
            }
        };

        // âœ… ì–´ë“œë¯¼(Firebase)ìœ¼ë¡œ ê²°ê³¼ ë‚ ë¦¬ëŠ” í•¨ìˆ˜
        async function sendToAdmin() {
            const user = JSON.parse(localStorage.getItem('toeic_user'));
            if (user) {
                try {
                    await setDoc(doc(db, "Winter_Users", user.userId), {
                        userId: user.userId,
                        userName: user.userName,
                        userClass: user.userClass,
                        // ì–´ë–¤ í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í–ˆëŠ”ì§€ ê¸°ë¡ (ì–´ë“œë¯¼ íŽ˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥)
                        passedShadowing: arrayUnion(`Test ${currentTestNum} ì™„ë£Œ`),
                        lastUpdate: new Date().toISOString()
                    }, { merge: true });
                    
                    alert(`ðŸ† TEST ${currentTestNum} ì™„ë²½í•˜ê²Œ ë§ˆì³¤ìŠµë‹ˆë‹¤!`);
                    location.href = "index.html";
                } catch (e) {
                    console.error("ì „ì†¡ ì˜¤ë¥˜:", e);
                    alert("ë°ì´í„° ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            } else {
                alert("ì‚¬ìš©ìž ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                location.href = "index.html";
            }
        }

        window.onload = init;
    </script>
</body>
</html>