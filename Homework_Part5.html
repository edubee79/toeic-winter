<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¬í™” íŠ¸ë ˆì´ë‹ | TOEIC Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">

    <nav class="p-6 flex items-center max-w-md mx-auto sticky top-0 bg-slate-900/80 backdrop-blur-md z-50">
        <button onclick="history.back()" class="text-slate-400 hover:text-white transition-colors">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        <div class="ml-4">
            <h1 id="display-unit-title" class="text-sm font-black text-indigo-400 uppercase tracking-widest italic">UNIT LOADING</h1>
        </div>
    </nav>

    <main class="max-w-md mx-auto px-6 pt-4 pb-20">
        <div class="w-full bg-slate-800 h-1.5 rounded-full mb-8 overflow-hidden">
            <div id="progress-bar" class="bg-indigo-500 h-full w-0 transition-all duration-500"></div>
        </div>

        <div id="quiz-container">
            <div class="mb-8">
                <span id="q-no" class="text-indigo-500 font-black text-5xl italic tracking-tighter">01</span>
                <p id="q-text" class="text-lg font-bold mt-4 leading-relaxed text-slate-200 min-h-[80px]">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div id="options-grid" class="grid gap-3"></div>
        </div>

        <div id="result-screen" class="hidden py-4 space-y-8">
            <div class="text-center">
                <div class="w-20 h-20 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-500 text-3xl shadow-2xl shadow-indigo-500/10">
                    <i class="fa-solid fa-trophy"></i>
                </div>
                <h2 class="text-3xl font-black mb-1 tracking-tighter uppercase text-white">Mission Complete</h2>
                <p id="final-score" class="text-slate-400 font-bold mb-6 italic text-lg"></p>
                
                <div class="grid grid-cols-2 gap-3 mb-10">
                    <button onclick="location.href='Part5_Lobby.html'" class="bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-black shadow-lg transition-all active:scale-95 text-sm">ë¡œë¹„ë¡œ ì´ë™</button>
                    <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl font-black transition-all text-sm">ë‹¤ì‹œ í’€ê¸°</button>
                </div>
            </div>

            <div id="wrong-note-section" class="space-y-4">
                <h3 class="text-sm font-black text-indigo-400 uppercase tracking-[0.2em] flex items-center gap-2 mb-6">
                    <i class="fa-solid fa-book-open"></i> Incorrect Notes
                </h3>
                <div id="wrong-details-container" class="space-y-8">
                    </div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBThrCtBNJuVcfPD3Vm6XvPD7McT5JJsN8", 
            authDomain: "eduthot-fb088.firebaseapp.com",
            projectId: "eduthot-fb088",
            storageBucket: "eduthot-fb088.firebasestorage.app",
            messagingSenderId: "919552710378",
            appId: "1:919552710378:web:7ba72ea2d195e092f8a993"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const unitId = urlParams.get('unit'); 
        
        let questions = [];
        let currentIndex = 0;
        let score = 0;
        let logs = []; 

        async function initQuiz() {
            if(!unitId) {
                alert("ìœ ë‹› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                location.href = 'Part5_Lobby.html';
                return;
            }
            try {
                const doc = await db.collection("Review_Questions").doc(unitId).get();
                if(doc.exists) {
                    questions = doc.data().inter;
                    document.getElementById('display-unit-title').innerText = unitId.replace(/_/g, ' ');
                    renderQuestion();
                } else {
                    alert("ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) { console.error(error); }
        }

        function renderQuestion() {
            const q = questions[currentIndex];
            document.getElementById('q-no').innerText = String(currentIndex + 1).padStart(2, '0');
            document.getElementById('q-text').innerText = q.question;
            document.getElementById('progress-bar').style.width = `${((currentIndex) / questions.length) * 100}%`;

            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';

            ['a', 'b', 'c', 'd'].forEach(key => {
                const btn = document.createElement('button');
                btn.className = "w-full p-5 bg-slate-800 border border-slate-700 rounded-2xl text-left font-bold hover:bg-slate-700 active:scale-[0.98] transition-all flex items-center group";
                btn.innerHTML = `
                    <span class="w-8 h-8 rounded-lg bg-slate-900 flex items-center justify-center mr-4 text-xs text-indigo-400 font-black border border-slate-700 group-hover:border-indigo-500 shrink-0">
                        ${key.toUpperCase()}
                    </span> 
                    <span class="text-slate-200 text-sm">${q.options[key]}</span>
                `;
                btn.onclick = () => handleAnswer(key);
                grid.appendChild(btn);
            });
        }

        async function handleAnswer(selected) {
            const q = questions[currentIndex];
            const isCorrect = selected === q.answer;
            if(isCorrect) score++;

            // í•´ì„¤(í•´ì„ í¬í•¨) ë°ì´í„°ë¥¼ ì €ì¥
            logs.push({
                question_no: q.question_no || (currentIndex + 1),
                question_text: q.question,
                options: q.options,
                is_correct: isCorrect,
                user_choice: selected,
                correct_answer: q.answer,
                explanation: q.explanation || "í•´ì„ ë° í•´ì„¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
            });

            if(currentIndex < questions.length - 1) {
                currentIndex++;
                renderQuestion();
            } else {
                await saveAndShowResult();
            }
        }

        async function saveAndShowResult() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('final-score').innerText = `SCORE: ${score} / ${questions.length}`;

            const container = document.getElementById('wrong-details-container');
            container.innerHTML = '';

            const wrongQuestions = logs.filter(log => !log.is_correct);

            if (wrongQuestions.length === 0) {
                container.innerHTML = `<div class="p-8 text-center bg-indigo-500/10 rounded-3xl border border-indigo-500/30 text-indigo-400 font-black">ë§Œì ì…ë‹ˆë‹¤! ğŸ‰</div>`;
            } else {
                wrongQuestions.forEach(log => {
                    const card = document.createElement('div');
                    card.className = "bg-slate-800/40 rounded-3xl p-6 border border-slate-700/50 shadow-xl overflow-hidden";
                    
                    let optionsHtml = ['a', 'b', 'c', 'd'].map(key => {
                        const isCorrect = key === log.correct_answer;
                        const isUserChoice = key === log.user_choice;
                        let stateClass = "bg-slate-900/30 border-slate-800 text-slate-500";
                        if (isCorrect) stateClass = "bg-emerald-500/10 border-emerald-500/40 text-emerald-400 font-bold";
                        if (isUserChoice && !isCorrect) stateClass = "bg-rose-500/10 border-rose-500/40 text-rose-400";

                        return `
                            <div class="flex items-center gap-3 p-3 rounded-xl border ${stateClass} mb-1.5 last:mb-0">
                                <span class="text-[10px] font-black uppercase">(${key})</span>
                                <span class="text-xs">${log.options[key]}</span>
                            </div>
                        `;
                    }).join('');

                    card.innerHTML = `
                        <div class="mb-4 flex justify-between items-center">
                            <span class="text-[10px] font-black text-rose-500 bg-rose-500/10 px-2 py-1 rounded-md uppercase tracking-widest">Question ${log.question_no}</span>
                            <span class="text-[10px] font-black text-slate-500 italic">Correct: ${log.correct_answer.toUpperCase()}</span>
                        </div>
                        <p class="text-sm font-bold text-slate-100 mb-4 leading-relaxed">${log.question_text}</p>
                        <div class="space-y-1 mb-6">${optionsHtml}</div>
                        
                        <div class="bg-indigo-500/5 rounded-2xl p-5 border-l-4 border-indigo-500">
                            <h4 class="text-[10px] font-black text-indigo-400 uppercase mb-2 tracking-tighter flex items-center gap-1">
                                <i class="fa-solid fa-circle-info text-[8px]"></i> í•´ì„¤ ë° í•´ì„
                            </h4>
                            <p class="text-[13px] text-slate-300 leading-relaxed whitespace-pre-wrap">${log.explanation}</p>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // Firebase ì €ì¥ ë¡œì§ ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼)
            const storedUser = localStorage.getItem('toeic_user');
            let studentName = "Unknown", studentId = "Unknown", studentClass = "Unknown";
            if (storedUser) {
                const userData = JSON.parse(storedUser);
                studentName = userData.userName;
                studentId = userData.userId;
                studentClass = userData.userClass;
            }
            try {
                await db.collection("Manager_Results").add({
                    unit: unitId,
                    student: studentName,
                    studentId: studentId,
                    studentClass: studentClass,
                    score: score,
                    total: questions.length,
                    details: logs,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch(e) { console.error(e); }
        }

        initQuiz();
    </script>
</body>
</html>