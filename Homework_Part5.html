<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>심화 트레이닝 | TOEIC Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">

    <nav class="p-6 flex items-center max-w-md mx-auto sticky top-0 bg-slate-900/80 backdrop-blur-md z-50">
        <button onclick="history.back()" class="text-slate-400 hover:text-white transition-colors">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        <div class="ml-4">
            <h1 id="display-unit-title" class="text-sm font-black text-indigo-400 uppercase tracking-widest italic">UNIT LOADING</h1>
        </div>
    </nav>

    <main class="max-w-md mx-auto px-6 pt-4 pb-20">
        <div class="w-full bg-slate-800 h-1.5 rounded-full mb-8 overflow-hidden">
            <div id="progress-bar" class="bg-indigo-500 h-full w-0 transition-all duration-500"></div>
        </div>

        <div id="quiz-container">
            <div class="mb-8">
                <span id="q-no" class="text-indigo-500 font-black text-5xl italic tracking-tighter">01</span>
                <p id="q-text" class="text-lg font-bold mt-4 leading-relaxed text-slate-200 min-h-[80px]">데이터를 불러오는 중입니다...</p>
            </div>

            <div id="options-grid" class="grid gap-3">
                </div>
        </div>

        <div id="result-screen" class="hidden text-center py-10">
            <div class="w-24 h-24 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-500 text-4xl shadow-2xl shadow-indigo-500/20">
                <i class="fa-solid fa-trophy"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 tracking-tighter">MISSION COMPLETE</h2>
            <p id="final-score" class="text-slate-400 mb-8 font-medium"></p>
            
            <div class="space-y-3">
                <button onclick="location.href='Part5_Lobby.html'" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-black shadow-lg shadow-indigo-500/30 transition-all active:scale-95">
                    다른 유닛 도전하기
                </button>
                <button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl font-black transition-all">
                    다시 풀기
                </button>
            </div>
        </div>
    </main>

    <script>
        // 1. Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyBThrCtBNJuVcfPD3Vm6XvPD7McT5JJsN8", 
            authDomain: "eduthot-fb088.firebaseapp.com",
            projectId: "eduthot-fb088",
            storageBucket: "eduthot-fb088.firebasestorage.app",
            messagingSenderId: "919552710378",
            appId: "1:919552710378:web:7ba72ea2d195e092f8a993"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. 변수 설정
        const urlParams = new URLSearchParams(window.location.search);
        const unitId = urlParams.get('unit'); // URL에서 ?unit=Unit_... 값을 읽음
        
        let questions = [];
        let currentIndex = 0;
        let score = 0;
        let logs = []; 

        // 3. 퀴즈 데이터 초기화
        async function initQuiz() {
            if(!unitId) {
                alert("유닛 정보가 없습니다. 로비로 이동합니다.");
                location.href = 'Part5_Lobby.html';
                return;
            }
            
            try {
                const doc = await db.collection("Review_Questions").doc(unitId).get();
                if(doc.exists) {
                    questions = doc.data().inter;
                    document.getElementById('display-unit-title').innerText = unitId.replace(/_/g, ' ');
                    renderQuestion();
                } else {
                    alert("해당 유닛의 문제를 찾을 수 없습니다.");
                }
            } catch (error) {
                console.error("데이터 로딩 에러:", error);
            }
        }

        // 4. 문제 렌더링 (화면에 그리기)
        function renderQuestion() {
            const q = questions[currentIndex];
            document.getElementById('q-no').innerText = String(currentIndex + 1).padStart(2, '0');
            document.getElementById('q-text').innerText = q.question;
            
            // 진행 바 업데이트
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${((currentIndex) / questions.length) * 100}%`;

            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';

            // A, B, C, D 버튼 생성
            ['a', 'b', 'c', 'd'].forEach(key => {
                const btn = document.createElement('button');
                btn.className = "w-full p-5 bg-slate-800 border border-slate-700 rounded-2xl text-left font-bold hover:bg-slate-700 active:scale-[0.98] transition-all flex items-center group";
                btn.innerHTML = `
                    <span class="w-8 h-8 rounded-lg bg-slate-900 flex items-center justify-center mr-4 text-xs text-indigo-400 font-black border border-slate-700 group-hover:border-indigo-500">
                        ${key.toUpperCase()}
                    </span> 
                    <span class="text-slate-200">${q.options[key]}</span>
                `;
                btn.onclick = () => handleAnswer(key);
                grid.appendChild(btn);
            });
        }

        // 5. 정답 확인 및 다음 문제 이동
        async function handleAnswer(selected) {
            const q = questions[currentIndex];
            const isCorrect = selected === q.answer;
            if(isCorrect) score++;

            // 상세 기록 저장 (나중에 오답노트용)
            logs.push({
                q_no: q.question_no,
                is_correct: isCorrect,
                user_choice: selected,
                correct_answer: q.answer
            });

            if(currentIndex < questions.length - 1) {
                currentIndex++;
                renderQuestion();
            } else {
                await saveAndShowResult();
            }
        }

        // 6. 결과 저장 및 종료 화면 표시
        async function saveAndShowResult() {
            // 화면 전환
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('final-score').innerText = `총 ${questions.length}문제 중 ${score}문제를 해결했습니다.`;

            // --- [로그인 정보 연동] ---
            const storedUser = localStorage.getItem('toeic_user');
            let studentName = "미확인 학생";
            let studentId = "Unknown";
            let studentClass = "Unknown";

            if (storedUser) {
                const userData = JSON.parse(storedUser); // 문자열을 객체로 변환
                studentName = userData.userName;
                studentId = userData.userId;
                studentClass = userData.userClass;
            }

            // --- [관리자 저장소(Manager_Results)로 전송] ---
            try {
                await db.collection("Manager_Results").add({
                    unit: unitId,
                    student: studentName,
                    studentId: studentId,
                    studentClass: studentClass,
                    score: score,
                    total: questions.length,
                    details: logs, // 상세 정오답 기록
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // 서버 시간 기준 저장
                });
            } catch(e) {
                console.error("데이터 저장 실패: ", e);
            }
        }

        // 실행 시작
        initQuiz();
    </script>
</body>
</html>