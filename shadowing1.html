<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shadowing Practice</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  padding:20px;
}
.container { max-width:480px; margin:auto; }
.card {
  background:#020617;
  padding:20px;
  border-radius:14px;
}
button {
  width:100%;
  padding:14px;
  font-size:16px;
  border:none;
  border-radius:10px;
  margin-top:12px;
}
.play { background:#1e293b; color:#fff; }
.mic { background:#4338ca; color:#fff; }
.mic.listening { background:#be123c; }
.mic.disabled { opacity:.5; }
.en { font-size:20px; margin-bottom:8px; }
.ko { color:#94a3b8; }
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="en" id="en"></div>
    <div class="ko" id="ko"></div>

    <button id="playBtn" class="play">â–¶ ë¬¸ì¥ ë“£ê¸°</button>
    <button id="micBtn" class="mic disabled" disabled>ğŸ¤ ë”°ë¼ ë§í•˜ê¸°</button>
  </div>
</div>

<script>
/* ================= ë°ì´í„° ================= */
const data = [
  { en: "Some people are gathered around a table.", ko: "ì‚¬ëŒë“¤ì´ í…Œì´ë¸”ì— ë‘˜ëŸ¬ì•‰ì•„ ìˆë‹¤." }
];

const enEl = document.getElementById("en");
const koEl = document.getElementById("ko");
const playBtn = document.getElementById("playBtn");
const micBtn = document.getElementById("micBtn");

enEl.textContent = data[0].en;
koEl.textContent = data[0].ko;

/* ================= ìƒíƒœ ================= */
let micUnlocked = false;
let listening = false;

/* ================= 1ï¸âƒ£ ë§ˆì´í¬ ê°•ì œ ì–¸ë½ ================= */
async function unlockMic() {
  if (micUnlocked) return;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(t => t.stop());
    micUnlocked = true;
  } catch (e) {
    alert("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤");
  }
}

/* ================= TTS ================= */
const synth = window.speechSynthesis;

playBtn.addEventListener("click", async () => {
  await unlockMic();

  micBtn.disabled = true;
  micBtn.classList.add("disabled");

  synth.cancel();
  const u = new SpeechSynthesisUtterance(data[0].en);
  u.lang = "en-US";
  u.rate = 0.85;

  u.onend = () => {
    // ì•ˆë“œë¡œì´ë“œ ì•ˆì •í™” ë”œë ˆì´
    setTimeout(() => {
      micBtn.disabled = false;
      micBtn.classList.remove("disabled");
    }, 500);
  };

  synth.speak(u);
});

/* ================= 2ï¸âƒ£ í´ë¦­ ì‹œ SpeechRecognition ìƒì„± ================= */
micBtn.addEventListener("click", async () => {
  if (listening) return;

  await unlockMic();

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
    return;
  }

  const recognition = new SR();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  listening = true;
  micBtn.classList.add("listening");
  micBtn.textContent = "ğŸ™ ë“£ëŠ” ì¤‘...";

  recognition.onresult = e => {
    alert("ì¸ì‹ ê²°ê³¼: " + e.results[0][0].transcript);
  };

  recognition.onerror = () => {
    listening = false;
    micBtn.classList.remove("listening");
    micBtn.textContent = "ğŸ¤ ë”°ë¼ ë§í•˜ê¸°";
  };

  recognition.onend = () => {
    listening = false;
    micBtn.classList.remove("listening");
    micBtn.textContent = "ğŸ¤ ë”°ë¼ ë§í•˜ê¸°";
  };

  try {
    recognition.start();
  } catch (e) {
    listening = false;
    micBtn.textContent = "ğŸ¤ ë”°ë¼ ë§í•˜ê¸°";
  }
});
</script>
</body>
</html>
