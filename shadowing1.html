<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shadowing Master | 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css'); body { font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }</style>
</head>
<body class="bg-slate-900 text-white min-h-screen font-pretendard">

    <div id="start-overlay" class="fixed inset-0 z-[200] bg-slate-900 flex flex-col items-center justify-center p-10 text-center">
        <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center mb-6 shadow-2xl animate-bounce">
            <i class="fas fa-microphone text-3xl text-white"></i>
        </div>
        <h2 class="text-2xl font-black mb-2 tracking-tighter">í•™ìŠµ ì‹œì‘í•˜ê¸°</h2>
        <p class="text-slate-400 font-bold text-sm mb-8">ëª¨ë°”ì¼ ìŒì„± ì¸ì‹ì„ í™œì„±í™”í•˜ê¸° ìœ„í•´<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
        <button id="permission-btn" class="w-full max-w-xs py-5 bg-white text-slate-900 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">ê¶Œí•œ í—ˆìš© ë° ì‹œì‘</button>
    </div>

    <nav class="p-6 flex justify-between items-center max-w-md mx-auto">
        <button onclick="location.href='index.html'" class="text-slate-400"><i class="fas fa-arrow-left text-xl"></i></button>
        <h1 id="nav-title" class="font-black text-lg tracking-tighter italic text-indigo-400 uppercase">SHADOWING</h1>
        <div class="w-8"></div>
    </nav>

    <main class="max-w-md mx-auto px-6 pb-20 text-center">
        <div class="mb-10 flex justify-between items-end text-left">
            <div>
                <p class="text-indigo-500 text-[10px] font-black uppercase tracking-widest mb-1">Step 02. Shadowing</p>
                <h2 class="text-2xl font-black italic">Listen & Repeat</h2>
            </div>
            <div id="progress-area" class="text-right">
                <span id="progress-text" class="text-indigo-400 font-black text-2xl">1</span><span id="total-text" class="text-slate-700 font-bold text-lg"> / --</span>
            </div>
        </div>

        <div class="bg-white rounded-[3rem] p-10 shadow-2xl mb-10 relative overflow-hidden min-h-[250px] flex items-center justify-center">
            <div id="sentence-box" class="blur-md transition-all duration-700">
                <p id="target-sentence" class="text-slate-900 font-black text-2xl leading-tight italic mb-4 tracking-tight"></p>
                <p id="sentence-mean" class="text-slate-400 font-bold text-sm"></p>
                <p id="attempt-counter" class="mt-4 text-[10px] font-bold text-rose-500 uppercase tracking-widest"></p>
            </div>
            <div id="play-overlay" class="absolute inset-0 flex items-center justify-center bg-white/80 backdrop-blur-sm">
                <button id="real-play-btn" class="w-24 h-24 bg-indigo-600 rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition-transform">
                    <i class="fas fa-play text-white text-4xl ml-1"></i>
                </button>
            </div>
        </div>

        <div class="space-y-6">
            <div id="status-msg" class="text-slate-500 font-black text-[10px] uppercase tracking-widest">ì¤‘ì•™ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì†Œë¦¬ë¥¼ ë“¤ìœ¼ì„¸ìš”</div>
            <button id="mic-btn" disabled class="w-full py-8 bg-slate-800 text-slate-600 rounded-[2.5rem] text-xl font-black transition-all">
                <i class="fas fa-microphone mr-3"></i> ì†Œë¦¬ë¥¼ ë¨¼ì € ë“¤ìœ¼ì„¸ìš”
            </button>
            <p id="user-transcript" class="text-indigo-400 font-bold italic text-sm min-h-[1.5rem]"></p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBThrCtBNJuVcfPD3Vm6XvPD7McT5JJsN8",
            authDomain: "eduthot-fb088.firebaseapp.com",
            projectId: "eduthot-fb088",
            storageBucket: "eduthot-fb088.firebasestorage.app",
            messagingSenderId: "919552710378",
            appId: "1:919552710378:web:7ba72ea2d195e092f8a993"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // [ë°ì´í„° ë¶€ë¶„ ìƒëµ ì—†ìŒ - ê¸°ì¡´ ë°ì´í„° ìœ ì§€ë¨]
        const allShadowData = {
            1: [
                {en: "Some people are gathered around a table.", ko: "ì‚¬ëŒë“¤ì´ í…Œì´ë¸”ì— ë‘˜ëŸ¬ì•‰ì•„ ìˆë‹¤."},
                {en: "He is leaning against the railing.", ko: "ê·¸ëŠ” ë‚œê°„ì— ê¸°ëŒ€ì–´ ìˆë‹¤."},
                {en: "A woman is reaching for an item.", ko: "ì—¬ìê°€ ë¬¼ê±´ì„ ì¡ìœ¼ë ¤ê³  ì†ì„ ë»—ê³  ìˆë‹¤."},
                {en: "They are facing each other.", ko: "ê·¸ë“¤ì´ ì„œë¡œ ë§ˆì£¼ ë³´ê³  ìˆë‹¤."},
                {en: "He is adjusting his glasses.", ko: "ê·¸ê°€ ì•ˆê²½ì„ ê³ ì³ ì“°ê³  ìˆë‹¤."},
                {en: "She is browsing in a bookstore.", ko: "ê·¸ë…€ê°€ ì„œì ì—ì„œ ì±…ì„ êµ¬ê²½í•˜ê³  ìˆë‹¤."},
                {en: "A man is sweeping the pavement.", ko: "ë‚¨ìê°€ ë³´ë„ë¥¼ ì“¸ê³  ìˆë‹¤."},
                {en: "He is gesturing with his hands.", ko: "ê·¸ê°€ ì†ìœ¼ë¡œ ëª¸ì§“ì„ í•˜ê³  ìˆë‹¤."},
                {en: "They are strolling along the walkway.", ko: "ê·¸ë“¤ì´ ì‚°ì±…ë¡œë¥¼ ë”°ë¼ ê±·ê³  ìˆë‹¤."},
                {en: "She is sorting through some papers.", ko: "ê·¸ë…€ê°€ ì¢…ì´ë“¤ì„ ë¶„ë¥˜í•˜ê³  ìˆë‹¤."},
                {en: "A person is pouring a beverage into a glass.", ko: "ìŒë£Œë¥¼ ì”ì— ë”°ë¥´ê³  ìˆë‹¤."},
                {en: "He is examining some documents.", ko: "ê·¸ëŠ” ë¬¸ì„œë¥¼ ê²€í† í•˜ê³  ìˆë‹¤."},
                {en: "They are shaking hands with each other.", ko: "ê·¸ë“¤ì€ ì„œë¡œ ì•…ìˆ˜í•˜ê³  ìˆë‹¤."},
                {en: "She is pointing at a screen.", ko: "ê·¸ë…€ëŠ” í™”ë©´ì„ ê°€ë¦¬í‚¤ê³  ìˆë‹¤."},
                {en: "The man is lifting a box.", ko: "ë‚¨ìê°€ ìƒìë¥¼ ë“¤ì–´ ì˜¬ë¦¬ê³  ìˆë‹¤."},
                {en: "He is taking a photograph of the scenery.", ko: "ê·¸ëŠ” í’ê²½ ì‚¬ì§„ì„ ì°ê³  ìˆë‹¤."},
                {en: "They are applauding the performance.", ko: "ê·¸ë“¤ì´ ê³µì—°ì— ë°•ìˆ˜ë¥¼ ì¹˜ê³  ìˆë‹¤."},
                {en: "She is wrapping a gift.", ko: "ê·¸ë…€ê°€ ì„ ë¬¼ì„ í¬ì¥í•˜ê³  ìˆë‹¤."},
                {en: "A man is typing on a keyboard.", ko: "ë‚¨ìê°€ í‚¤ë³´ë“œë¡œ íƒ€ì´í•‘ì„ í•˜ê³  ìˆë‹¤."},
                {en: "They are waiting in line.", ko: "ê·¸ë“¤ì´ ì¤„ì„ ì„œì„œ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤."},
                {en: "He is pushing a cart through the aisle.", ko: "ê·¸ê°€ í†µë¡œì—ì„œ ì¹´íŠ¸ë¥¼ ë°€ê³  ìˆë‹¤."},
                {en: "She is drinking from a water fountain.", ko: "ê·¸ë…€ê°€ ì‹ìˆ˜ëŒ€ì—ì„œ ë¬¼ì„ ë§ˆì‹œê³  ìˆë‹¤."},
                {en: "They are discussing some information.", ko: "ê·¸ë“¤ì´ ì •ë³´ë¥¼ ë…¼ì˜í•˜ê³  ìˆë‹¤."},
                {en: "A man is boarding a bus.", ko: "ë‚¨ìê°€ ë²„ìŠ¤ì— ì˜¬ë¼íƒ€ê³  ìˆë‹¤."},
                {en: "He is checking his reflection in the mirror.", ko: "ê·¸ê°€ ê±°ìš¸ì— ë¹„ì¹œ ëª¨ìŠµì„ í™•ì¸í•˜ê³  ìˆë‹¤."},
                {en: "She is wiping the counter with a cloth.", ko: "ê·¸ë…€ê°€ ì²œìœ¼ë¡œ ì¹´ìš´í„°ë¥¼ ë‹¦ê³  ìˆë‹¤."},
                {en: "They are hiking up a mountain.", ko: "ê·¸ë“¤ì´ ì‚°ì„ ë“±ë°˜í•˜ê³  ìˆë‹¤."},
                {en: "He is repairing a bicycle.", ko: "ê·¸ê°€ ìì „ê±°ë¥¼ ìˆ˜ë¦¬í•˜ê³  ìˆë‹¤."},
                {en: "She is handing a document to her colleague.", ko: "ê·¸ë…€ê°€ ë™ë£Œì—ê²Œ ì„œë¥˜ë¥¼ ê±´ë„¤ê³  ìˆë‹¤."},
                {en: "A man is tying his shoelaces.", ko: "ë‚¨ìê°€ ì‹ ë°œëˆì„ ë¬¶ê³  ìˆë‹¤."},
                {en: "They are sitting across from each other.", ko: "ê·¸ë“¤ì´ ì„œë¡œ ë§ˆì£¼ ë³´ê³  ì•‰ì•„ ìˆë‹¤."},
                {en: "He is reading a menu.", ko: "ê·¸ëŠ” ë©”ë‰´íŒì„ ì½ê³  ìˆë‹¤."},
                {en: "She is carrying a briefcase.", ko: "ê·¸ë…€ê°€ ì„œë¥˜ ê°€ë°©ì„ ë“¤ê³  ìˆë‹¤."}
            ],
            2: [
                {en: "Merchandise is being displayed in the shop.", ko: "ìƒí’ˆì´ ê°€ê²Œì— ì „ì‹œë˜ê³  ìˆë‹¤."},
                {en: "A plant has been placed in the corner.", ko: "ì‹ë¬¼ì´ êµ¬ì„ì— ë†“ì—¬ ìˆë‹¤."},
                {en: "The vehicles are parked in a row.", ko: "ì°¨ëŸ‰ë“¤ì´ í•œ ì¤„ë¡œ ì£¼ì°¨ë˜ì–´ ìˆë‹¤."},
                {en: "Some boxes are stacked on top of each other.", ko: "ìƒìë“¤ì´ ê²¹ê²¹ì´ ìŒ“ì—¬ ìˆë‹¤."},
                {en: "The curtains have been drawn shut.", ko: "ì»¤íŠ¼ì´ ì³ì ¸ ìˆë‹¤."},
                {en: "Some steps lead up to a building.", ko: "ê³„ë‹¨ì´ ê±´ë¬¼ë¡œ ì´ì–´ì ¸ ìˆë‹¤."},
                {en: "The tables are unoccupied.", ko: "í…Œì´ë¸”ì´ ë¹„ì–´ ìˆë‹¤."},
                {en: "The path is shaded by some trees.", ko: "ê¸¸ì´ ë‚˜ë¬´ì— ì˜í•´ ê·¸ëŠ˜ì ¸ ìˆë‹¤."},
                {en: "Equipment is being set up in the lab.", ko: "ì‹¤í—˜ì‹¤ì— ì¥ë¹„ê°€ ì„¤ì¹˜ë˜ê³  ìˆë‹¤."},
                {en: "The boat is docked at the pier.", ko: "ë°°ê°€ ë¶€ë‘ì— ì •ë°•í•´ ìˆë‹¤."},
                {en: "Shadows are being cast on the ground.", ko: "ë°”ë‹¥ì— ê·¸ë¦¼ìê°€ ë“œë¦¬ì›Œì ¸ ìˆë‹¤."},
                {en: "The shelves are filled with books.", ko: "ì„ ë°˜ì´ ì±…ìœ¼ë¡œ ê°€ë“ ì°¨ ìˆë‹¤."},
                {en: "A clock is hanging on the wall.", ko: "ì‹œê³„ê°€ ë²½ì— ê±¸ë ¤ ìˆë‹¤."},
                {en: "The outdoor chairs are folded.", ko: "ì•¼ì™¸ìš© ì˜ìë“¤ì´ ì ‘í˜€ ìˆë‹¤."},
                {en: "The lawn is being mowed.", ko: "ì”ë””ê°€ ê¹ì´ê³  ìˆë‹¤."},
                {en: "Traffic lights are positioned above the street.", ko: "ì‹ í˜¸ë“±ì´ ë„ë¡œ ìœ„ì— ìœ„ì¹˜í•´ ìˆë‹¤."},
                {en: "Signs are posted on the fence.", ko: "í‘œì§€íŒì´ ìš¸íƒ€ë¦¬ì— ë¶™ì–´ ìˆë‹¤."},
                {en: "A rug has been spread on the floor.", ko: "ì¹´í«ì´ ë°”ë‹¥ì— ê¹”ë ¤ ìˆë‹¤."},
                {en: "The fountain is spraying water into the air.", ko: "ë¶„ìˆ˜ê°€ ê³µì¤‘ìœ¼ë¡œ ë¬¼ì„ ë¿œê³  ìˆë‹¤."},
                {en: "Some bicycles are leaned against a wall.", ko: "ìì „ê±°ë“¤ì´ ë²½ì— ê¸°ëŒ€ì–´ ìˆë‹¤."},
                {en: "A statue is located in the center of the park.", ko: "ì¡°ê°ìƒì´ ê³µì› ì¤‘ì•™ì— ìœ„ì¹˜í•´ ìˆë‹¤."},
                {en: "The balcony overlooks the ocean.", ko: "ë°œì½”ë‹ˆì—ì„œ ë°”ë‹¤ê°€ ë‚´ë‹¤ë³´ì¸ë‹¤."},
                {en: "Baskets are hanging from the ceiling.", ko: "ë°”êµ¬ë‹ˆë“¤ì´ ì²œì¥ì— ë§¤ë‹¬ë ¤ ìˆë‹¤."},
                {en: "Boxes are being loaded onto a truck.", ko: "ìƒìë“¤ì´ íŠ¸ëŸ­ì— ì‹¤ë¦¬ê³  ìˆë‹¤."},
                {en: "The doorway is blocked by a ladder.", ko: "ì¶œì…êµ¬ê°€ ì‚¬ë‹¤ë¦¬ì— ì˜í•´ ë§‰í˜€ ìˆë‹¤."},
                {en: "Papers are scattered on the desk.", ko: "ì¢…ì´ë“¤ì´ ì±…ìƒ ìœ„ì— í©ì–´ì ¸ ìˆë‹¤."},
                {en: "A fence runs along the perimeter.", ko: "ìš¸íƒ€ë¦¬ê°€ ì£¼ë³€ì„ ë”°ë¼ ë‘˜ëŸ¬ì³ì ¸ ìˆë‹¤."},
                {en: "The lamp is switched on.", ko: "ë¨í”„ê°€ ì¼œì ¸ ìˆë‹¤."},
                {en: "The seats are arranged in rows.", ko: "ì¢Œì„ë“¤ì´ ì—¬ëŸ¬ ì¤„ë¡œ ë°°ì—´ë˜ì–´ ìˆë‹¤."},
                {en: "A bridge connects the two islands.", ko: "ë‹¤ë¦¬ê°€ ë‘ ì„¬ì„ ì—°ê²°í•˜ê³  ìˆë‹¤."},
                {en: "Windows are being cleaned.", ko: "ì°½ë¬¸ë“¤ì´ ë‹¦ì´ê³  ìˆë‹¤."},
                {en: "Flower pots decorate the windowsills.", ko: "í™”ë¶„ë“¤ì´ ì°½í‹€ì„ ì¥ì‹í•˜ê³  ìˆë‹¤."},
                {en: "The garage door is closed.", ko: "ì°¨ê³  ë¬¸ì´ ë‹«í˜€ ìˆë‹¤."}
            ],
            3: [
                {en: "A reflection is visible in the window.", ko: "ì°½ë¬¸ì— ë¹„ì¹œ ëª¨ìŠµì´ ë³´ì¸ë‹¤."},
                {en: "Construction work is in progress.", ko: "ê³µì‚¬ê°€ ì§„í–‰ ì¤‘ì´ë‹¤."},
                {en: "The containers have been emptied.", ko: "ìš©ê¸°ë“¤ì´ ë¹„ì›Œì ¸ ìˆë‹¤."},
                {en: "The labels are attached to the jars.", ko: "ë¼ë²¨ì´ ë³‘ì— ë¶™ì–´ ìˆë‹¤."},
                {en: "A bridge spans a waterway.", ko: "ë‹¤ë¦¬ê°€ ìˆ˜ë¡œë¥¼ ê°€ë¡œì§€ë¥´ê³  ìˆë‹¤."},
                {en: "The floor is being mopped.", ko: "ë°”ë‹¥ì„ ëŒ€ê±¸ë ˆë¡œ ë‹¦ê³  ìˆë‹¤."},
                {en: "Items have been arranged in a display case.", ko: "ë¬¼ê±´ë“¤ì´ ì§„ì—´ì¥ì— ë°°ì¹˜ë˜ì–´ ìˆë‹¤."},
                {en: "Potted plants are lined up on a ledge.", ko: "í™”ë¶„ë“¤ì´ ì„ ë°˜ ìœ„ì— ì¤„ì§€ì–´ ìˆë‹¤."},
                {en: "The ceiling is under repair.", ko: "ì²œì¥ì´ ìˆ˜ë¦¬ ì¤‘ì´ë‹¤."},
                {en: "The road is being repaved.", ko: "ë„ë¡œê°€ ì¬í¬ì¥ë˜ê³  ìˆë‹¤."},
                {en: "Some tools are scattered on the workbench.", ko: "ê³µêµ¬ë“¤ì´ ì‘ì—…ëŒ€ì— í©ì–´ì ¸ ìˆë‹¤."},
                {en: "A rug is being rolled up.", ko: "ì¹´í˜íŠ¸ê°€ ë§ë¦¬ê³  ìˆë‹¤."},
                {en: "The door has been left open.", ko: "ë¬¸ì´ ì—´ë¦° ì±„ë¡œ ìˆë‹¤."},
                {en: "Scaffolding has been erected against the wall.", ko: "ë²½ì— ë¹„ê³„ê°€ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤."},
                {en: "A basket is being filled with fruit.", ko: "ë°”êµ¬ë‹ˆì— ê³¼ì¼ì´ ë‹´ê¸°ê³  ìˆë‹¤."},
                {en: "The awning provides shade for the diners.", ko: "ì°¨ì–‘ì´ ì‹ì‚¬í•˜ëŠ” ì‚¬ëŒë“¤ì—ê²Œ ê·¸ëŠ˜ì„ ì œê³µí•œë‹¤."},
                {en: "Some tiles are being replaced.", ko: "íƒ€ì¼ì´ êµì²´ë˜ê³  ìˆë‹¤."},
                {en: "A walkway leads to the beach.", ko: "ë³´ë„ê°€ í•´ë³€ìœ¼ë¡œ ì´ì–´ì§„ë‹¤."},
                {en: "Boats are anchored in the harbor.", ko: "ë°°ë“¤ì´ í•­êµ¬ì— ì •ë°•í•´ ìˆë‹¤."},
                {en: "Trees line both sides of the street.", ko: "ë‚˜ë¬´ë“¤ì´ ë„ë¡œ ì–‘ìª½ì— ì¤„ì§€ì–´ ìˆë‹¤."},
                {en: "The stairs are made of stone.", ko: "ê³„ë‹¨ì€ ëŒë¡œ ë§Œë“¤ì–´ì ¸ ìˆë‹¤."},
                {en: "An umbrella is providing shade.", ko: "ìš°ì‚°ì´ ê·¸ëŠ˜ì„ ë§Œë“¤ì–´ì£¼ê³  ìˆë‹¤."},
                {en: "The building is surrounded by water.", ko: "ê±´ë¬¼ì´ ë¬¼ë¡œ ë‘˜ëŸ¬ì‹¸ì—¬ ìˆë‹¤."},
                {en: "A package is being delivered.", ko: "íƒë°°ê°€ ë°°ë‹¬ë˜ê³  ìˆë‹¤."},
                {en: "Flowers are blooming in the garden.", ko: "ì •ì›ì— ê½ƒë“¤ì´ í”¼ì–´ ìˆë‹¤."},
                {en: "The painting is framed.", ko: "ê·¸ë¦¼ì´ ì•¡ìì— ë¼ì›Œì ¸ ìˆë‹¤."},
                {en: "A path winds through the forest.", ko: "ê¸¸ì´ ìˆ²ì†ì„ êµ¬ë¶€ëŸ¬ì ¸ ì´ì–´ì ¸ ìˆë‹¤."},
                {en: "The stadium is packed with people.", ko: "ê²½ê¸°ì¥ì´ ì‚¬ëŒë“¤ë¡œ ê°€ë“ ì°¨ ìˆë‹¤."},
                {en: "A banner is displayed above the entrance.", ko: "í˜„ìˆ˜ë§‰ì´ ì…êµ¬ ìœ„ì— ê²Œì‹œë˜ì–´ ìˆë‹¤."},
                {en: "The roof is flat.", ko: "ì§€ë¶•ì´ í‰í‰í•˜ë‹¤."},
                {en: "The gate is locked.", ko: "ëŒ€ë¬¸ì´ ì ê²¨ ìˆë‹¤."},
                {en: "Supplies are being unpacked.", ko: "ë¬¼í’ˆë“¤ì´ í’€ë¦¬ê³  ìˆë‹¤."},
                {en: "Water is flowing from a pipe.", ko: "íŒŒì´í”„ì—ì„œ ë¬¼ì´ íë¥´ê³  ìˆë‹¤."},
                {en: "A ladder is leaning against a tree.", ko: "ì‚¬ë‹¤ë¦¬ê°€ ë‚˜ë¬´ì— ê¸°ëŒ€ì–´ ìˆë‹¤."}
            ]
        };

        let recognition = null;
        const synth = window.speechSynthesis;
        let currentIndex = 0;
        let attemptCount = 0;
        let currentDayData = [];

        document.getElementById('permission-btn').addEventListener('click', async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());

                const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = false;

                recognition.onresult = (event) => handleResult(event.results[0][0].transcript);
                recognition.onerror = () => resetMicBtn();
                recognition.onend = () => resetMicBtn();

                synth.speak(new SpeechSynthesisUtterance(""));
                document.getElementById('start-overlay').classList.add('hidden');
                initSession();
            } catch (err) {
                alert("ë§ˆì´í¬ ê¶Œí•œ í—ˆìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }, { once: true });

        function initSession() {
            const day = localStorage.getItem('shadow_day') || 1;
            currentDayData = allShadowData[day] || allShadowData[1];
            loadSentence();
        }

        function loadSentence() {
            const data = currentDayData[currentIndex];
            attemptCount = 0; 
            updateAttemptUI();

            document.getElementById('target-sentence').innerText = data.en;
            document.getElementById('sentence-mean').innerText = data.ko;
            document.getElementById('total-text').innerText = " / " + currentDayData.length;
            document.getElementById('progress-text').innerText = currentIndex + 1;
            
            document.getElementById('sentence-box').classList.add('blur-md');
            document.getElementById('play-overlay').style.display = 'flex';
            document.getElementById('mic-btn').disabled = true;
            document.getElementById('mic-btn').innerText = "ì†Œë¦¬ë¥¼ ë¨¼ì € ë“¤ìœ¼ì„¸ìš”";
            document.getElementById('mic-btn').className = "w-full py-8 bg-slate-800 text-slate-600 rounded-[2.5rem] text-xl font-black";
        }

        document.getElementById('real-play-btn').onclick = () => {
            synth.cancel();
            const utter = new SpeechSynthesisUtterance(currentDayData[currentIndex].en);
            utter.lang = 'en-US';
            utter.rate = 0.8;
            utter.onend = () => {
                document.getElementById('sentence-box').classList.remove('blur-md');
                document.getElementById('play-overlay').style.display = 'none';
                document.getElementById('mic-btn').disabled = false;
                document.getElementById('mic-btn').className = "w-full py-8 bg-indigo-600 text-white rounded-[2.5rem] text-xl font-black";
                document.getElementById('mic-btn').innerText = "ë§ˆì´í¬ ëˆ„ë¥´ê³  ë”°ë¼í•˜ê¸°";
            };
            synth.speak(utter);
        };

        document.getElementById('mic-btn').onclick = () => {
            if (!recognition) return;
            recognition.start();
            document.getElementById('mic-btn').innerText = "ë“£ê³  ìˆìŠµë‹ˆë‹¤...";
            document.getElementById('mic-btn').className = "w-full py-8 bg-rose-500 text-white rounded-[2.5rem] text-xl font-black scale-95";
        };

        function handleResult(speech) {
            document.getElementById('user-transcript').innerText = `ë‚´ ë°œìŒ: "${speech}"`;
            const target = currentDayData[currentIndex].en.toLowerCase().replace(/[.,!?]/g, "");
            const result = speech.toLowerCase().replace(/[.,!?]/g, "");

            if (result.includes(target) || result.split(' ').length > 3) {
                nextSentence();
            } else {
                attemptCount++;
                updateAttemptUI();
                if (attemptCount >= 5) {
                    alert("5ë²ˆ ì‹œë„ ì‹¤íŒ¨! ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.");
                    nextSentence();
                } else {
                    alert(`${attemptCount}íšŒ ì‹¤íŒ¨! ë‹¤ì‹œ í•œ ë²ˆ ë“¤ë ¤ë“œë¦´ê²Œìš”.`);
                    document.getElementById('real-play-btn').click(); 
                }
            }
        }

        function nextSentence() {
            currentIndex++;
            if (currentIndex < currentDayData.length) {
                loadSentence();
            } else {
                finishSession();
            }
        }

        // [ìˆ˜ì •ë¨] ê´€ë¦¬ì í˜ì´ì§€ì™€ ì—°ë™ë˜ë„ë¡ ì €ì¥ ë¡œì§ ë³€ê²½
        async function finishSession() {
            const storedUser = localStorage.getItem('toeic_user');
            const day = localStorage.getItem('shadow_day') || 1;
            
            if(storedUser) {
                const user = JSON.parse(storedUser);
                try {
                    // 'Winter_Users' ì»¬ë ‰ì…˜ì— 'completed_shadowing' ë°°ì—´ë¡œ ì €ì¥
                    await setDoc(doc(db, "Winter_Users", user.userId), {
                        userId: user.userId,
                        userName: user.userName,
                        userClass: user.userClass,
                        // Unit 01, Unit 02 í˜•ì‹ìœ¼ë¡œ ì €ì¥
                        completed_shadowing: arrayUnion(`Unit ${day.toString().padStart(2, '0')}`),
                        lastUpdate: new Date().toISOString()
                    }, { merge: true });

                    alert(`ğŸ† ì˜¤ëŠ˜ì˜ Shadowing Unit ${day} í•™ìŠµì„ ëª¨ë‘ ë§ˆì³¤ìŠµë‹ˆë‹¤! ê¸°ë¡ì´ ê´€ë¦¬ìì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (e) {
                    console.error("ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:", e);
                    alert("í•™ìŠµì€ ë§ˆì³¤ìœ¼ë‚˜ ê¸°ë¡ ì €ì¥ ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            } else {
                alert("í•™ìŠµ ì™„ë£Œ! (ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ì–´ ì„œë²„ì— ì €ì¥ë˜ì§€ëŠ” ì•Šì•˜ìŠµë‹ˆë‹¤)");
            }
            location.href = "index.html"; 
        }

        function updateAttemptUI() {
            const counterEl = document.getElementById('attempt-counter');
            if (attemptCount > 0) {
                counterEl.innerText = `Attempt: ${attemptCount} / 5`;
            } else {
                counterEl.innerText = "";
            }
        }

        function resetMicBtn() {
            const btn = document.getElementById('mic-btn');
            if(!btn.disabled) {
                btn.innerText = "ë§ˆì´í¬ ëˆ„ë¥´ê³  ë”°ë¼í•˜ê¸°";
                btn.className = "w-full py-8 bg-indigo-600 text-white rounded-[2.5rem] text-xl font-black";
            }
        }
    </script>
</body>
</html>