<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | 통합 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css'); body { font-family: 'Pretendard', sans-serif; }</style>
</head>
<body class="bg-slate-100 p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tighter uppercase italic">Management <span class="text-indigo-600">Pro</span></h1>
                <p class="text-slate-500 text-xs font-bold mt-1">학생의 모든 과제 진행 현황을 실시간으로 관리하세요.</p>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="location.href='Manager_Logs.html'" class="px-5 py-2.5 bg-white text-slate-600 rounded-2xl text-xs font-black border border-slate-200 hover:bg-slate-50 transition-all flex items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-list-ul"></i> 전체 로그
                </button>

                <div id="filter-container" class="flex gap-1 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                    <button onclick="filterClass('all', this)" class="filter-btn px-5 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold transition-all shadow-lg shadow-slate-200">전체</button>
                    <button onclick="filterClass('650', this)" class="filter-btn px-5 py-2 hover:bg-slate-50 text-slate-600 rounded-xl text-sm font-bold transition-all">650반</button>
                    <button onclick="filterClass('780', this)" class="filter-btn px-5 py-2 hover:bg-slate-50 text-slate-600 rounded-xl text-sm font-bold transition-all">780반</button>
                </div>
            </div>
        </header>

        <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-200">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-200 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <th class="p-6">Class</th>
                        <th class="p-6">Student Info</th>
                        <th class="p-6">Overall Progress</th>
                        <th class="p-6 text-indigo-500">Latest Activity</th>
                        <th class="p-6 text-center">Detail</th>
                    </tr>
                </thead>
                <tbody id="student-list">
                    <tr><td colspan="5" class="p-20 text-center text-slate-300 font-bold"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> 데이터를 불러오는 중...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex justify-end">
        <div class="w-full max-w-lg bg-white h-full shadow-2xl overflow-y-auto animate-slide-in flex flex-col">
            <div class="p-8 border-b sticky top-0 bg-white/90 backdrop-blur-md z-10 flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-1">Student Dashboard</p>
                    <h2 id="modal-student-name" class="text-3xl font-black text-slate-900 tracking-tight">학습 기록</h2>
                    <p id="modal-student-id" class="text-xs text-slate-400 font-bold mt-1 tracking-tighter"></p>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 bg-slate-100 text-slate-400 rounded-2xl flex items-center justify-center hover:bg-rose-50 hover:text-rose-500 transition-all">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div id="modal-content" class="p-8 space-y-6">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBThrCtBNJuVcfPD3Vm6XvPD7McT5JJsN8", 
            authDomain: "eduthot-fb088.firebaseapp.com", 
            projectId: "eduthot-fb088", 
            storageBucket: "eduthot-fb088.firebasestorage.app", 
            messagingSenderId: "919552710378", 
            appId: "1:919552710378:web:7ba72ea2d195e092f8a993" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allHomeworkLogs = [];
        let studentsData = [];
        let currentFilter = 'all';

        function listenToLogs() {
            const q = query(collection(db, "Manager_Results"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                allHomeworkLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadStudents();
            });
        }

        async function loadStudents() {
            const querySnapshot = await getDocs(collection(db, "Winter_Users"));
            studentsData = querySnapshot.docs.map(doc => doc.data());
            
            const list = document.getElementById('student-list');
            list.innerHTML = '';

            studentsData.forEach(student => {
                if (currentFilter !== 'all' && String(student.userClass) !== currentFilter) return;

                const studentLogs = allHomeworkLogs.filter(log => log.studentId === student.userId || log.student === student.userName);
                const recentLog = studentLogs[0];
                const vocaCount = student.passedVocaDays ? student.passedVocaDays.length : 0;
                
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 group cursor-pointer";
                row.onclick = () => showStudentDashboard(student.userName, student.userId);

                row.innerHTML = `
                    <td class="p-6 font-bold text-slate-400 text-sm">${student.userClass}반</td>
                    <td class="p-6">
                        <div class="flex flex-col text-left">
                            <span class="font-black text-slate-900 group-hover:text-indigo-600 transition-colors">${student.userName || '미입력'}</span>
                            <span class="text-[10px] text-slate-400 font-medium">${student.userId}</span>
                        </div>
                    </td>
                    <td class="p-6">
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-0.5 bg-emerald-50 text-emerald-600 text-[9px] font-black rounded-md border border-emerald-100 italic">VOCA ${vocaCount}D</span>
                            ${studentLogs.some(l => l.unit.includes('Shadowing')) ? '<span class="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-[9px] font-black rounded-md border border-indigo-100 italic">PART1</span>' : ''}
                            ${studentLogs.some(l => l.unit.includes('LCpart2') || l.unit.includes('Part2')) ? '<span class="px-2 py-0.5 bg-rose-50 text-rose-600 text-[9px] font-black rounded-md border border-rose-100 italic">PART2</span>' : ''}
                        </div>
                    </td>
                    <td class="p-6">
                        ${recentLog ? `
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-indigo-500 uppercase">${recentLog.unit.replace(/_/g, ' ')}</span>
                                <span class="text-[9px] text-slate-400">${new Date(recentLog.timestamp?.toDate()).toLocaleDateString()}</span>
                            </div>
                        ` : '<span class="text-slate-200 italic text-[10px]">기록 없음</span>'}
                    </td>
                    <td class="p-6 text-center">
                        <i class="fa-solid fa-arrow-right-long text-slate-200 group-hover:text-indigo-500 transition-all"></i>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        window.showStudentDashboard = (name, id) => {
            const student = studentsData.find(s => s.userId === id);
            const studentLogs = allHomeworkLogs.filter(log => log.studentId === id || log.student === name);
            
            document.getElementById('modal-student-name').innerText = name;
            document.getElementById('modal-student-id').innerText = `학번: ${id} | ${student?.userClass || '-'}반`;

            // 과제별 통계 계산
            let maxShadowSet = 0;
            let lc2Count = 0;
            let grammarCount = 0;

            studentLogs.forEach(log => {
                const u = log.unit || "";
                if (u.includes('Shadowing')) {
                    const m = u.match(/Set(\d+)/);
                    if (m && parseInt(m[1]) > maxShadowSet) maxShadowSet = parseInt(m[1]);
                } else if (u.includes('LCpart2') || u.includes('Part2')) {
                    lc2Count++;
                } else if (u.includes('Grammar') || u.includes('Unit')) {
                    grammarCount++;
                }
            });

            const vocaCount = student?.passedVocaDays ? student.passedVocaDays.length : 0;

            document.getElementById('modal-content').innerHTML = `
                <div class="bg-indigo-600 rounded-[2rem] p-6 text-white shadow-xl shadow-indigo-100 relative overflow-hidden">
                    <i class="fa-solid fa-microphone absolute -right-4 -top-4 text-7xl text-indigo-500 opacity-30 rotate-12"></i>
                    <h3 class="text-[10px] font-black text-indigo-200 uppercase tracking-widest mb-4">Part 1 Shadowing</h3>
                    <div class="flex items-end justify-between mb-3">
                        <span class="text-4xl font-black italic">${(maxShadowSet/5*100)}%</span>
                        <span class="text-xs font-bold text-indigo-100">${maxShadowSet} / 5 Sets</span>
                    </div>
                    <div class="w-full bg-indigo-900/40 h-2 rounded-full overflow-hidden"><div class="bg-white h-full" style="width: ${(maxShadowSet/5*100)}%"></div></div>
                </div>

                <div class="bg-rose-500 rounded-[2rem] p-6 text-white shadow-xl shadow-rose-100 relative overflow-hidden">
                    <i class="fa-solid fa-headphones absolute -right-4 -top-4 text-7xl text-rose-400 opacity-30 -rotate-12"></i>
                    <h3 class="text-[10px] font-black text-rose-100 uppercase tracking-widest mb-4">Part 2 Real Test</h3>
                    <div class="flex items-end justify-between mb-3">
                        <span class="text-4xl font-black italic">${Math.min((lc2Count/5*100), 100)}%</span>
                        <span class="text-xs font-bold text-rose-100">${lc2Count} / 5 Times</span>
                    </div>
                    <div class="w-full bg-rose-900/40 h-2 rounded-full overflow-hidden"><div class="bg-white h-full" style="width: ${Math.min((lc2Count/5*100), 100)}%"></div></div>
                </div>

                <div class="bg-blue-500 rounded-[2rem] p-6 text-white shadow-xl shadow-blue-100 relative overflow-hidden">
                    <i class="fa-solid fa-pen-to-square absolute -right-4 -top-4 text-7xl text-blue-400 opacity-30 rotate-12"></i>
                    <h3 class="text-[10px] font-black text-blue-100 uppercase tracking-widest mb-4">Grammar Mission</h3>
                    <div class="flex items-end justify-between mb-3">
                        <span class="text-4xl font-black italic">${Math.min((grammarCount/10*100), 100)}%</span>
                        <span class="text-xs font-bold text-blue-100">${grammarCount} / 10 Times</span>
                    </div>
                    <div class="w-full bg-blue-900/40 h-2 rounded-full overflow-hidden"><div class="bg-white h-full" style="width: ${Math.min((grammarCount/10*100), 100)}%"></div></div>
                </div>

                <div class="bg-emerald-500 rounded-[2rem] p-6 text-white shadow-xl shadow-emerald-100 relative overflow-hidden">
                    <i class="fa-solid fa-book absolute -right-4 -top-4 text-7xl text-emerald-400 opacity-30 -rotate-12"></i>
                    <h3 class="text-[10px] font-black text-emerald-100 uppercase tracking-widest mb-4">Vocabulary</h3>
                    <div class="flex items-end justify-between mb-3">
                        <span class="text-4xl font-black italic">${(vocaCount/30*100).toFixed(0)}%</span>
                        <span class="text-xs font-bold text-emerald-100">${vocaCount} / 30 Days</span>
                    </div>
                    <div class="w-full bg-emerald-900/40 h-2 rounded-full overflow-hidden"><div class="bg-white h-full" style="width: ${(vocaCount/30*100)}%"></div></div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 pl-1">Recent 5 Logs</h3>
                    <div class="space-y-3">
                        ${studentLogs.slice(0, 5).map(log => `
                            <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">${log.unit.replace(/_/g, ' ')}</p>
                                    <p class="text-xs font-bold text-slate-700">${new Date(log.timestamp?.toDate()).toLocaleString()}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-black text-indigo-600">${log.score}</span><span class="text-[10px] text-slate-400">/${log.total}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.closeModal = () => {
            document.getElementById('detail-modal').classList.add('hidden');
            document.body.style.overflow = '';
        };

        window.filterClass = (cls, btn) => {
            currentFilter = String(cls);
            document.querySelectorAll('.filter-btn').forEach(b => b.className = "filter-btn px-5 py-2 hover:bg-slate-50 text-slate-600 rounded-xl text-sm font-bold transition-all");
            btn.className = "filter-btn px-5 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold transition-all shadow-lg shadow-slate-200";
            loadStudents();
        };

        listenToLogs();
    </script>

    <style>
        @keyframes slide-in { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-slide-in { animation: slide-in 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</body>
</html>