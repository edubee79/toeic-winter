<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | í†µí•© ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css'); body { font-family: 'Pretendard', sans-serif; }</style>
</head>
<body class="bg-slate-100 p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tighter uppercase italic">Management <span class="text-indigo-600">Pro</span></h1>
                <p class="text-slate-500 text-xs font-bold mt-1">í•™ìƒì˜ ëª¨ë“  ê³¼ì œ ì§„í–‰ í˜„í™©ì„ í•œëˆˆì— ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="location.href='Manager_Logs.html'" class="px-5 py-2.5 bg-white text-slate-600 rounded-2xl text-xs font-black border border-slate-200 hover:bg-slate-50 transition-all flex items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-list-ul"></i> ì „ì²´ ë¡œê·¸
                </button>

                <div id="filter-container" class="flex gap-1 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                    <button onclick="filterClass('all', this)" class="filter-btn px-5 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold transition-all shadow-lg shadow-slate-200">ì „ì²´</button>
                    <button onclick="filterClass('650', this)" class="filter-btn px-5 py-2 hover:bg-slate-50 text-slate-600 rounded-xl text-sm font-bold transition-all">650ë°˜</button>
                    <button onclick="filterClass('780', this)" class="filter-btn px-5 py-2 hover:bg-slate-50 text-slate-600 rounded-xl text-sm font-bold transition-all">780ë°˜</button>
                </div>
            </div>
        </header>

        <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-200">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-200 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <th class="p-6">Class</th>
                        <th class="p-6">Student Info</th>
                        <th class="p-6">Voca Mastery</th>
                        <th class="p-6 text-indigo-500">Recent Shadowing</th>
                        <th class="p-6 text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="student-list">
                    <tr><td colspan="5" class="p-20 text-center text-slate-300 font-bold"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex justify-end">
        <div class="w-full max-w-lg bg-white h-full shadow-2xl overflow-y-auto animate-slide-in flex flex-col">
            <div class="p-8 border-b sticky top-0 bg-white/90 backdrop-blur-md z-10 flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-1">Student Dashboard</p>
                    <h2 id="modal-student-name" class="text-3xl font-black text-slate-900 tracking-tight">í•™ìŠµ ê¸°ë¡</h2>
                    <p id="modal-student-id" class="text-xs text-slate-400 font-bold mt-1 tracking-tighter"></p>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 bg-slate-100 text-slate-400 rounded-2xl flex items-center justify-center hover:bg-rose-50 hover:text-rose-500 transition-all">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div id="modal-content" class="p-8 space-y-10">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBThrCtBNJuVcfPD3Vm6XvPD7McT5JJsN8", 
            authDomain: "eduthot-fb088.firebaseapp.com", 
            projectId: "eduthot-fb088", 
            storageBucket: "eduthot-fb088.firebasestorage.app", 
            messagingSenderId: "919552710378", 
            appId: "1:919552710378:web:7ba72ea2d195e092f8a993" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allHomeworkLogs = [];
        let studentsData = [];
        let currentFilter = 'all';

        // 1. ì‹¤ì‹œê°„ ë¡œê·¸ ê°ì‹œ
        function listenToLogs() {
            const q = query(collection(db, "Manager_Results"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                allHomeworkLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadStudents();
            });
        }

        // 2. í•™ìƒ ëª©ë¡ ë¡œë“œ ë° ë Œë”ë§
        async function loadStudents() {
            const querySnapshot = await getDocs(collection(db, "Winter_Users"));
            studentsData = querySnapshot.docs.map(doc => doc.data());
            
            const list = document.getElementById('student-list');
            list.innerHTML = '';

            studentsData.forEach(student => {
                if (currentFilter !== 'all' && String(student.userClass) !== currentFilter) return;

                // í•´ë‹¹ í•™ìƒì˜ ê°€ì¥ ìµœê·¼ ë¡œê·¸ ì°¾ê¸°
                const studentLogs = allHomeworkLogs.filter(log => log.studentId === student.userId || log.student === student.userName);
                const recentLog = studentLogs[0];

                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 group cursor-pointer";
                row.setAttribute('onclick', `showStudentDashboard('${student.userName}', '${student.userId}')`);
                row.setAttribute('data-class', String(student.userClass));

                const vocaCount = student.passedVocaDays ? student.passedVocaDays.length : 0;
                
                row.innerHTML = `
                    <td class="p-6 font-bold text-slate-400 text-sm">${student.userClass}ë°˜</td>
                    <td class="p-6">
                        <div class="flex flex-col text-left">
                            <span class="font-black text-slate-900 group-hover:text-indigo-600 transition-colors">${student.userName || 'ë¯¸ì…ë ¥'}</span>
                            <span class="text-[10px] text-slate-400 font-medium">${student.userId}</span>
                        </div>
                    </td>
                    <td class="p-6">
                        <div class="flex items-center gap-2">
                            <div class="w-20 bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                <div class="bg-emerald-400 h-full" style="width: ${(vocaCount/30)*100}%"></div>
                            </div>
                            <span class="text-[10px] font-bold text-slate-500">${vocaCount}/30D</span>
                        </div>
                    </td>
                    <td class="p-6">
                        ${recentLog ? `
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-indigo-500 uppercase">${recentLog.unit.replace(/_/g, ' ')}</span>
                                <span class="text-[9px] text-slate-400">${new Date(recentLog.timestamp?.toDate()).toLocaleDateString()} ì™„ë£Œ</span>
                            </div>
                        ` : '<span class="text-slate-200 italic text-[10px]">ê¸°ë¡ ì—†ìŒ</span>'}
                    </td>
                    <td class="p-6 text-center">
                        <i class="fa-solid fa-chevron-right text-slate-200 group-hover:text-indigo-300 transition-all"></i>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        // 3. ğŸŒŸ í†µí•© ëŒ€ì‹œë³´ë“œ í‘œì‹œ (í•µì‹¬ ê¸°ëŠ¥)
        window.showStudentDashboard = (name, id) => {
            const student = studentsData.find(s => s.userId === id);
            const studentLogs = allHomeworkLogs.filter(log => log.studentId === id || log.student === name);
            
            document.getElementById('modal-student-name').innerText = name;
            document.getElementById('modal-student-id').innerText = `í•™ë²ˆ/ID: ${id} | ${student?.userClass || '-'}ë°˜`;

            // ì‰ë„ì‰ ì§„ì²™ë„ ê³„ì‚° (ê°€ì¥ ë†’ì€ Set ì°¾ê¸°)
            let maxShadowSet = 0;
            studentLogs.forEach(log => {
                if (log.unit.includes('Shadowing')) {
                    const match = log.unit.match(/Set(\d+)/);
                    if (match && parseInt(match[1]) > maxShadowSet) maxShadowSet = parseInt(match[1]);
                }
            });

            const vocaCount = student?.passedVocaDays ? student.passedVocaDays.length : 0;
            const shadowPercent = (maxShadowSet / 5) * 100;
            const vocaPercent = (vocaCount / 30) * 100;

            let timelineHTML = studentLogs.map(log => {
                const date = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : "-";
                return `
                    <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div class="w-8 h-8 bg-white rounded-xl shadow-sm flex items-center justify-center text-indigo-500 flex-shrink-0">
                            <i class="fa-solid ${log.unit.includes('Shadowing') ? 'fa-microphone' : 'fa-book-open'} text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${log.unit.replace(/_/g, ' ')}</p>
                            <p class="text-sm font-black text-slate-800">${log.score} / ${log.total} <span class="ml-2 text-[10px] text-emerald-500">Completed</span></p>
                            <p class="text-[9px] text-slate-400 mt-1">${date}</p>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('modal-content').innerHTML = `
                <div class="bg-indigo-600 rounded-[2rem] p-6 text-white shadow-xl shadow-indigo-100 relative overflow-hidden">
                    <i class="fa-solid fa-microphone absolute -right-4 -bottom-4 text-8xl text-indigo-500 opacity-20"></i>
                    <div class="relative z-10">
                        <h3 class="text-xs font-black text-indigo-200 uppercase tracking-[0.2em] mb-4">Shadowing Progress</h3>
                        <div class="flex items-end justify-between mb-2">
                            <span class="text-4xl font-black italic">${shadowPercent}%</span>
                            <span class="text-xs font-bold text-indigo-200">${maxShadowSet * 20} / 100 Sentences</span>
                        </div>
                        <div class="w-full bg-indigo-800/50 h-3 rounded-full overflow-hidden">
                            <div class="bg-white h-full transition-all duration-1000" style="width: ${shadowPercent}%"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-emerald-500 rounded-[2rem] p-6 text-white shadow-xl shadow-emerald-100 relative overflow-hidden">
                    <i class="fa-solid fa-book-open absolute -right-4 -bottom-4 text-8xl text-emerald-400 opacity-20"></i>
                    <div class="relative z-10">
                        <h3 class="text-xs font-black text-emerald-100 uppercase tracking-[0.2em] mb-4">Vocabulary Mastery</h3>
                        <div class="flex items-end justify-between mb-2">
                            <span class="text-4xl font-black italic">${vocaPercent.toFixed(0)}%</span>
                            <span class="text-xs font-bold text-emerald-100">${vocaCount} / 30 Days</span>
                        </div>
                        <div class="w-full bg-emerald-700/30 h-3 rounded-full overflow-hidden">
                            <div class="bg-white h-full transition-all duration-1000" style="width: ${vocaPercent}%"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-4 pl-1">Recent Activities</h3>
                    <div class="space-y-3">
                        ${timelineHTML || '<p class="text-center py-10 text-slate-300 font-bold">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                    </div>
                </div>
            `;

            document.getElementById('detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.closeModal = () => {
            document.getElementById('detail-modal').classList.add('hidden');
            document.body.style.overflow = '';
        };

        window.filterClass = (cls, btn) => {
            currentFilter = String(cls);
            document.querySelectorAll('.filter-btn').forEach(b => b.className = "filter-btn px-5 py-2 hover:bg-slate-50 text-slate-600 rounded-xl text-sm font-bold transition-all");
            btn.className = "filter-btn px-5 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold transition-all shadow-lg shadow-slate-200";
            loadStudents();
        };

        listenToLogs();
    </script>

    <style>
        @keyframes slide-in { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-slide-in { animation: slide-in 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</body>
</html>